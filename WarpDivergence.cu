#include "cuda_runtime.h"
#include "device_launch_parameters.h"
#include <stdio.h>
#include <stdlib.h>
#include <string.h>

// warp divergence test

__global__ void WarpDivergence(float *c)
{
	int tid = threadIdx.x + blockIdx.x * blockDim.x;
	float a, b;
	a = b = 0.0;

	if (tid % 2 == 0)
	{
		a = 100;
	}
	else
	{
		b = 200;
	}
	c[tid] = a + b;
}

__global__ void WarpIntegration(float *c)
{
	int tid = threadIdx.x + blockIdx.x * blockDim.x;
	float a, b;
	a = b = 0.0;

	if ((tid / warpSize) % 2 == 0)
	{
		a = 100;
	}
	else
	{
		b = 200;
	}
	c[tid] = a + b;
}

// debug the array
void PrintArray(float *A, int N)
{
	int i;
	int sum = 0;
	for (i = 0; i < N; i++)
	{
		sum++;
		printf("%.2f  ", A[i]);
		if (sum % 10 == 0)
		{
			printf("\n");
		}
	}
	printf("\n");
}


int main(int argc, char *argv[])
{
	int N = 1 << 10;
	float *h_C = NULL;
	float *d_C = NULL;

	h_C = (float *)malloc(sizeof(float)*N);
	memset(h_C, 0, sizeof(float)*N);

	cudaMalloc((float **)&d_C, sizeof(float)*N);
	cudaMemset(d_C, 0, sizeof(float)*N);

	dim3 block(128, 1);
	dim3 grid((N + block.x - 1) / block.x, 1);

	WarpDivergence << <grid, block >> >(d_C);
	cudaDeviceSynchronize();

	cudaMemcpy(h_C, d_C, sizeof(float)*N, cudaMemcpyDeviceToHost);
	PrintArray(h_C, N);

	printf("\n\n********************************************\n\n");

	cudaMemset(d_C, 0, sizeof(float)*N);       // reset the memory to zero
	WarpIntegration << <grid, block >> >(d_C);
	cudaDeviceSynchronize();

	cudaMemcpy(h_C, d_C, sizeof(float)*N, cudaMemcpyDeviceToHost);
	PrintArray(h_C, N);

	// release the allocated memory
	cudaFree(d_C);
	free(h_C);

	return 0;
}


// RESULT:
//  100.00  200.00  100.00  200.00  100.00  200.00  100.00  200.00  100.00  200.00
//  100.00  200.00  100.00  200.00  100.00  200.00  100.00  200.00  100.00  200.00
//  100.00  200.00  100.00  200.00  100.00  200.00  100.00  200.00  100.00  200.00
//  100.00  200.00  100.00  200.00  100.00  200.00  100.00  200.00  100.00  200.00
//  100.00  200.00  100.00  200.00  100.00  200.00  100.00  200.00  100.00  200.00
//  100.00  200.00  100.00  200.00  100.00  200.00  100.00  200.00  100.00  200.00
//  100.00  200.00  100.00  200.00  100.00  200.00  100.00  200.00  100.00  200.00
//  100.00  200.00  100.00  200.00  100.00  200.00  100.00  200.00  100.00  200.00
//  100.00  200.00  100.00  200.00  100.00  200.00  100.00  200.00  100.00  200.00
//  100.00  200.00  100.00  200.00  100.00  200.00  100.00  200.00  100.00  200.00
//  100.00  200.00  100.00  200.00  100.00  200.00  100.00  200.00  100.00  200.00
//  100.00  200.00  100.00  200.00  100.00  200.00  100.00  200.00  100.00  200.00
//  100.00  200.00  100.00  200.00  100.00  200.00  100.00  200.00  100.00  200.00
//  100.00  200.00  100.00  200.00  100.00  200.00  100.00  200.00  100.00  200.00
//  100.00  200.00  100.00  200.00  100.00  200.00  100.00  200.00  100.00  200.00
//  100.00  200.00  100.00  200.00  100.00  200.00  100.00  200.00  100.00  200.00
//  100.00  200.00  100.00  200.00  100.00  200.00  100.00  200.00  100.00  200.00
//  100.00  200.00  100.00  200.00  100.00  200.00  100.00  200.00  100.00  200.00
//  100.00  200.00  100.00  200.00  100.00  200.00  100.00  200.00  100.00  200.00
//  100.00  200.00  100.00  200.00  100.00  200.00  100.00  200.00  100.00  200.00
//  100.00  200.00  100.00  200.00  100.00  200.00  100.00  200.00  100.00  200.00
//  100.00  200.00  100.00  200.00  100.00  200.00  100.00  200.00  100.00  200.00
//  100.00  200.00  100.00  200.00  100.00  200.00  100.00  200.00  100.00  200.00
//  100.00  200.00  100.00  200.00  100.00  200.00  100.00  200.00  100.00  200.00
//  100.00  200.00  100.00  200.00  100.00  200.00  100.00  200.00  100.00  200.00
//  100.00  200.00  100.00  200.00  100.00  200.00  100.00  200.00  100.00  200.00
//  100.00  200.00  100.00  200.00  100.00  200.00  100.00  200.00  100.00  200.00
//  100.00  200.00  100.00  200.00  100.00  200.00  100.00  200.00  100.00  200.00
//  100.00  200.00  100.00  200.00  100.00  200.00  100.00  200.00  100.00  200.00
//  100.00  200.00  100.00  200.00  100.00  200.00  100.00  200.00  100.00  200.00
//  100.00  200.00  100.00  200.00  100.00  200.00  100.00  200.00  100.00  200.00
//  100.00  200.00  100.00  200.00  100.00  200.00  100.00  200.00  100.00  200.00
//  100.00  200.00  100.00  200.00  100.00  200.00  100.00  200.00  100.00  200.00
//  100.00  200.00  100.00  200.00  100.00  200.00  100.00  200.00  100.00  200.00
//  100.00  200.00  100.00  200.00  100.00  200.00  100.00  200.00  100.00  200.00
//  100.00  200.00  100.00  200.00  100.00  200.00  100.00  200.00  100.00  200.00
//  100.00  200.00  100.00  200.00  100.00  200.00  100.00  200.00  100.00  200.00
//  100.00  200.00  100.00  200.00  100.00  200.00  100.00  200.00  100.00  200.00
//  100.00  200.00  100.00  200.00  100.00  200.00  100.00  200.00  100.00  200.00
//  100.00  200.00  100.00  200.00  100.00  200.00  100.00  200.00  100.00  200.00
//  100.00  200.00  100.00  200.00  100.00  200.00  100.00  200.00  100.00  200.00
//  100.00  200.00  100.00  200.00  100.00  200.00  100.00  200.00  100.00  200.00
//  100.00  200.00  100.00  200.00  100.00  200.00  100.00  200.00  100.00  200.00
//  100.00  200.00  100.00  200.00  100.00  200.00  100.00  200.00  100.00  200.00
//  100.00  200.00  100.00  200.00  100.00  200.00  100.00  200.00  100.00  200.00
//  100.00  200.00  100.00  200.00  100.00  200.00  100.00  200.00  100.00  200.00
//  100.00  200.00  100.00  200.00  100.00  200.00  100.00  200.00  100.00  200.00
//  100.00  200.00  100.00  200.00  100.00  200.00  100.00  200.00  100.00  200.00
//  100.00  200.00  100.00  200.00  100.00  200.00  100.00  200.00  100.00  200.00
//  100.00  200.00  100.00  200.00  100.00  200.00  100.00  200.00  100.00  200.00
//  100.00  200.00  100.00  200.00  100.00  200.00  100.00  200.00  100.00  200.00
//  100.00  200.00  100.00  200.00  100.00  200.00  100.00  200.00  100.00  200.00
//  100.00  200.00  100.00  200.00  100.00  200.00  100.00  200.00  100.00  200.00
//  100.00  200.00  100.00  200.00  100.00  200.00  100.00  200.00  100.00  200.00
//  100.00  200.00  100.00  200.00  100.00  200.00  100.00  200.00  100.00  200.00
//  100.00  200.00  100.00  200.00  100.00  200.00  100.00  200.00  100.00  200.00
//  100.00  200.00  100.00  200.00  100.00  200.00  100.00  200.00  100.00  200.00
//  100.00  200.00  100.00  200.00  100.00  200.00  100.00  200.00  100.00  200.00
//  100.00  200.00  100.00  200.00  100.00  200.00  100.00  200.00  100.00  200.00
//  100.00  200.00  100.00  200.00  100.00  200.00  100.00  200.00  100.00  200.00
//  100.00  200.00  100.00  200.00  100.00  200.00  100.00  200.00  100.00  200.00
//  100.00  200.00  100.00  200.00  100.00  200.00  100.00  200.00  100.00  200.00
//  100.00  200.00  100.00  200.00  100.00  200.00  100.00  200.00  100.00  200.00
//  100.00  200.00  100.00  200.00  100.00  200.00  100.00  200.00  100.00  200.00
//  100.00  200.00  100.00  200.00  100.00  200.00  100.00  200.00  100.00  200.00
//  100.00  200.00  100.00  200.00  100.00  200.00  100.00  200.00  100.00  200.00
//  100.00  200.00  100.00  200.00  100.00  200.00  100.00  200.00  100.00  200.00
//  100.00  200.00  100.00  200.00  100.00  200.00  100.00  200.00  100.00  200.00
//  100.00  200.00  100.00  200.00  100.00  200.00  100.00  200.00  100.00  200.00
//  100.00  200.00  100.00  200.00  100.00  200.00  100.00  200.00  100.00  200.00
//  100.00  200.00  100.00  200.00  100.00  200.00  100.00  200.00  100.00  200.00
//  100.00  200.00  100.00  200.00  100.00  200.00  100.00  200.00  100.00  200.00
//  100.00  200.00  100.00  200.00  100.00  200.00  100.00  200.00  100.00  200.00
//  100.00  200.00  100.00  200.00  100.00  200.00  100.00  200.00  100.00  200.00
//  100.00  200.00  100.00  200.00  100.00  200.00  100.00  200.00  100.00  200.00
//  100.00  200.00  100.00  200.00  100.00  200.00  100.00  200.00  100.00  200.00
//  100.00  200.00  100.00  200.00  100.00  200.00  100.00  200.00  100.00  200.00
//  100.00  200.00  100.00  200.00  100.00  200.00  100.00  200.00  100.00  200.00
//  100.00  200.00  100.00  200.00  100.00  200.00  100.00  200.00  100.00  200.00
//  100.00  200.00  100.00  200.00  100.00  200.00  100.00  200.00  100.00  200.00
//  100.00  200.00  100.00  200.00  100.00  200.00  100.00  200.00  100.00  200.00
//  100.00  200.00  100.00  200.00  100.00  200.00  100.00  200.00  100.00  200.00
//  100.00  200.00  100.00  200.00  100.00  200.00  100.00  200.00  100.00  200.00
//  100.00  200.00  100.00  200.00  100.00  200.00  100.00  200.00  100.00  200.00
//  100.00  200.00  100.00  200.00  100.00  200.00  100.00  200.00  100.00  200.00
//  100.00  200.00  100.00  200.00  100.00  200.00  100.00  200.00  100.00  200.00
//  100.00  200.00  100.00  200.00  100.00  200.00  100.00  200.00  100.00  200.00
//  100.00  200.00  100.00  200.00  100.00  200.00  100.00  200.00  100.00  200.00
//  100.00  200.00  100.00  200.00  100.00  200.00  100.00  200.00  100.00  200.00
//  100.00  200.00  100.00  200.00  100.00  200.00  100.00  200.00  100.00  200.00
//  100.00  200.00  100.00  200.00  100.00  200.00  100.00  200.00  100.00  200.00
//  100.00  200.00  100.00  200.00  100.00  200.00  100.00  200.00  100.00  200.00
//  100.00  200.00  100.00  200.00  100.00  200.00  100.00  200.00  100.00  200.00
//  100.00  200.00  100.00  200.00  100.00  200.00  100.00  200.00  100.00  200.00
//  100.00  200.00  100.00  200.00  100.00  200.00  100.00  200.00  100.00  200.00
//  100.00  200.00  100.00  200.00  100.00  200.00  100.00  200.00  100.00  200.00
//  100.00  200.00  100.00  200.00  100.00  200.00  100.00  200.00  100.00  200.00
//  100.00  200.00  100.00  200.00  100.00  200.00  100.00  200.00  100.00  200.00
//  100.00  200.00  100.00  200.00  100.00  200.00  100.00  200.00  100.00  200.00
//  100.00  200.00  100.00  200.00  100.00  200.00  100.00  200.00  100.00  200.00
//  100.00  200.00  100.00  200.00  100.00  200.00  100.00  200.00  100.00  200.00
//  100.00  200.00  100.00  200.00  100.00  200.00  100.00  200.00  100.00  200.00
//  100.00  200.00  100.00  200.00
//  
//  
//  ********************************************
//  
//  100.00  100.00  100.00  100.00  100.00  100.00  100.00  100.00  100.00  100.00
//  100.00  100.00  100.00  100.00  100.00  100.00  100.00  100.00  100.00  100.00
//  100.00  100.00  100.00  100.00  100.00  100.00  100.00  100.00  100.00  100.00
//  100.00  100.00  200.00  200.00  200.00  200.00  200.00  200.00  200.00  200.00
//  200.00  200.00  200.00  200.00  200.00  200.00  200.00  200.00  200.00  200.00
//  200.00  200.00  200.00  200.00  200.00  200.00  200.00  200.00  200.00  200.00
//  200.00  200.00  200.00  200.00  100.00  100.00  100.00  100.00  100.00  100.00
//  100.00  100.00  100.00  100.00  100.00  100.00  100.00  100.00  100.00  100.00
//  100.00  100.00  100.00  100.00  100.00  100.00  100.00  100.00  100.00  100.00
//  100.00  100.00  100.00  100.00  100.00  100.00  200.00  200.00  200.00  200.00
//  200.00  200.00  200.00  200.00  200.00  200.00  200.00  200.00  200.00  200.00
//  200.00  200.00  200.00  200.00  200.00  200.00  200.00  200.00  200.00  200.00
//  200.00  200.00  200.00  200.00  200.00  200.00  200.00  200.00  100.00  100.00
//  100.00  100.00  100.00  100.00  100.00  100.00  100.00  100.00  100.00  100.00
//  100.00  100.00  100.00  100.00  100.00  100.00  100.00  100.00  100.00  100.00
//  100.00  100.00  100.00  100.00  100.00  100.00  100.00  100.00  100.00  100.00
//  200.00  200.00  200.00  200.00  200.00  200.00  200.00  200.00  200.00  200.00
//  200.00  200.00  200.00  200.00  200.00  200.00  200.00  200.00  200.00  200.00
//  200.00  200.00  200.00  200.00  200.00  200.00  200.00  200.00  200.00  200.00
//  200.00  200.00  100.00  100.00  100.00  100.00  100.00  100.00  100.00  100.00
//  100.00  100.00  100.00  100.00  100.00  100.00  100.00  100.00  100.00  100.00
//  100.00  100.00  100.00  100.00  100.00  100.00  100.00  100.00  100.00  100.00
//  100.00  100.00  100.00  100.00  200.00  200.00  200.00  200.00  200.00  200.00
//  200.00  200.00  200.00  200.00  200.00  200.00  200.00  200.00  200.00  200.00
//  200.00  200.00  200.00  200.00  200.00  200.00  200.00  200.00  200.00  200.00
//  200.00  200.00  200.00  200.00  200.00  200.00  100.00  100.00  100.00  100.00
//  100.00  100.00  100.00  100.00  100.00  100.00  100.00  100.00  100.00  100.00
//  100.00  100.00  100.00  100.00  100.00  100.00  100.00  100.00  100.00  100.00
//  100.00  100.00  100.00  100.00  100.00  100.00  100.00  100.00  200.00  200.00
//  200.00  200.00  200.00  200.00  200.00  200.00  200.00  200.00  200.00  200.00
//  200.00  200.00  200.00  200.00  200.00  200.00  200.00  200.00  200.00  200.00
//  200.00  200.00  200.00  200.00  200.00  200.00  200.00  200.00  200.00  200.00
//  100.00  100.00  100.00  100.00  100.00  100.00  100.00  100.00  100.00  100.00
//  100.00  100.00  100.00  100.00  100.00  100.00  100.00  100.00  100.00  100.00
//  100.00  100.00  100.00  100.00  100.00  100.00  100.00  100.00  100.00  100.00
//  100.00  100.00  200.00  200.00  200.00  200.00  200.00  200.00  200.00  200.00
//  200.00  200.00  200.00  200.00  200.00  200.00  200.00  200.00  200.00  200.00
//  200.00  200.00  200.00  200.00  200.00  200.00  200.00  200.00  200.00  200.00
//  200.00  200.00  200.00  200.00  100.00  100.00  100.00  100.00  100.00  100.00
//  100.00  100.00  100.00  100.00  100.00  100.00  100.00  100.00  100.00  100.00
//  100.00  100.00  100.00  100.00  100.00  100.00  100.00  100.00  100.00  100.00
//  100.00  100.00  100.00  100.00  100.00  100.00  200.00  200.00  200.00  200.00
//  200.00  200.00  200.00  200.00  200.00  200.00  200.00  200.00  200.00  200.00
//  200.00  200.00  200.00  200.00  200.00  200.00  200.00  200.00  200.00  200.00
//  200.00  200.00  200.00  200.00  200.00  200.00  200.00  200.00  100.00  100.00
//  100.00  100.00  100.00  100.00  100.00  100.00  100.00  100.00  100.00  100.00
//  100.00  100.00  100.00  100.00  100.00  100.00  100.00  100.00  100.00  100.00
//  100.00  100.00  100.00  100.00  100.00  100.00  100.00  100.00  100.00  100.00
//  200.00  200.00  200.00  200.00  200.00  200.00  200.00  200.00  200.00  200.00
//  200.00  200.00  200.00  200.00  200.00  200.00  200.00  200.00  200.00  200.00
//  200.00  200.00  200.00  200.00  200.00  200.00  200.00  200.00  200.00  200.00
//  200.00  200.00  100.00  100.00  100.00  100.00  100.00  100.00  100.00  100.00
//  100.00  100.00  100.00  100.00  100.00  100.00  100.00  100.00  100.00  100.00
//  100.00  100.00  100.00  100.00  100.00  100.00  100.00  100.00  100.00  100.00
//  100.00  100.00  100.00  100.00  200.00  200.00  200.00  200.00  200.00  200.00
//  200.00  200.00  200.00  200.00  200.00  200.00  200.00  200.00  200.00  200.00
//  200.00  200.00  200.00  200.00  200.00  200.00  200.00  200.00  200.00  200.00
//  200.00  200.00  200.00  200.00  200.00  200.00  100.00  100.00  100.00  100.00
//  100.00  100.00  100.00  100.00  100.00  100.00  100.00  100.00  100.00  100.00
//  100.00  100.00  100.00  100.00  100.00  100.00  100.00  100.00  100.00  100.00
//  100.00  100.00  100.00  100.00  100.00  100.00  100.00  100.00  200.00  200.00
//  200.00  200.00  200.00  200.00  200.00  200.00  200.00  200.00  200.00  200.00
//  200.00  200.00  200.00  200.00  200.00  200.00  200.00  200.00  200.00  200.00
//  200.00  200.00  200.00  200.00  200.00  200.00  200.00  200.00  200.00  200.00
//  100.00  100.00  100.00  100.00  100.00  100.00  100.00  100.00  100.00  100.00
//  100.00  100.00  100.00  100.00  100.00  100.00  100.00  100.00  100.00  100.00
//  100.00  100.00  100.00  100.00  100.00  100.00  100.00  100.00  100.00  100.00
//  100.00  100.00  200.00  200.00  200.00  200.00  200.00  200.00  200.00  200.00
//  200.00  200.00  200.00  200.00  200.00  200.00  200.00  200.00  200.00  200.00
//  200.00  200.00  200.00  200.00  200.00  200.00  200.00  200.00  200.00  200.00
//  200.00  200.00  200.00  200.00  100.00  100.00  100.00  100.00  100.00  100.00
//  100.00  100.00  100.00  100.00  100.00  100.00  100.00  100.00  100.00  100.00
//  100.00  100.00  100.00  100.00  100.00  100.00  100.00  100.00  100.00  100.00
//  100.00  100.00  100.00  100.00  100.00  100.00  200.00  200.00  200.00  200.00
//  200.00  200.00  200.00  200.00  200.00  200.00  200.00  200.00  200.00  200.00
//  200.00  200.00  200.00  200.00  200.00  200.00  200.00  200.00  200.00  200.00
//  200.00  200.00  200.00  200.00  200.00  200.00  200.00  200.00  100.00  100.00
//  100.00  100.00  100.00  100.00  100.00  100.00  100.00  100.00  100.00  100.00
//  100.00  100.00  100.00  100.00  100.00  100.00  100.00  100.00  100.00  100.00
//  100.00  100.00  100.00  100.00  100.00  100.00  100.00  100.00  100.00  100.00
//  200.00  200.00  200.00  200.00  200.00  200.00  200.00  200.00  200.00  200.00
//  200.00  200.00  200.00  200.00  200.00  200.00  200.00  200.00  200.00  200.00
//  200.00  200.00  200.00  200.00  200.00  200.00  200.00  200.00  200.00  200.00
//  200.00  200.00  100.00  100.00  100.00  100.00  100.00  100.00  100.00  100.00
//  100.00  100.00  100.00  100.00  100.00  100.00  100.00  100.00  100.00  100.00
//  100.00  100.00  100.00  100.00  100.00  100.00  100.00  100.00  100.00  100.00
//  100.00  100.00  100.00  100.00  200.00  200.00  200.00  200.00  200.00  200.00
//  200.00  200.00  200.00  200.00  200.00  200.00  200.00  200.00  200.00  200.00
//  200.00  200.00  200.00  200.00  200.00  200.00  200.00  200.00  200.00  200.00
//  200.00  200.00  200.00  200.00  200.00  200.00  100.00  100.00  100.00  100.00
//  100.00  100.00  100.00  100.00  100.00  100.00  100.00  100.00  100.00  100.00
//  100.00  100.00  100.00  100.00  100.00  100.00  100.00  100.00  100.00  100.00
//  100.00  100.00  100.00  100.00  100.00  100.00  100.00  100.00  200.00  200.00
//  200.00  200.00  200.00  200.00  200.00  200.00  200.00  200.00  200.00  200.00
//  200.00  200.00  200.00  200.00  200.00  200.00  200.00  200.00  200.00  200.00
//  200.00  200.00  200.00  200.00  200.00  200.00  200.00  200.00  200.00  200.00
//  100.00  100.00  100.00  100.00  100.00  100.00  100.00  100.00  100.00  100.00
//  100.00  100.00  100.00  100.00  100.00  100.00  100.00  100.00  100.00  100.00
//  100.00  100.00  100.00  100.00  100.00  100.00  100.00  100.00  100.00  100.00
//  100.00  100.00  200.00  200.00  200.00  200.00  200.00  200.00  200.00  200.00
//  200.00  200.00  200.00  200.00  200.00  200.00  200.00  200.00  200.00  200.00
//  200.00  200.00  200.00  200.00  200.00  200.00  200.00  200.00  200.00  200.00
//  200.00  200.00  200.00  200.00
//  Press any key to continue. . .